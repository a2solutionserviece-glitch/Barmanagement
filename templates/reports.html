{% extends "base.html" %}
{% block title %}Reports{% endblock %}

{% block content %}

<div class="container-fluid">

    <h2 class="mb-4">ðŸ“Š Sales Reports</h2>

    <!-- FILTER SECTION -->
    <div class="card shadow-sm mb-4 p-3">

        <h5 class="mb-3">Filters</h5>

        <div class="row g-3">

            <!-- Quick Filter -->
            <div class="col-md-3">
                <label class="form-label">Report Type</label>
                <select id="quickFilter" class="form-select">
                    <option value="daily">Today</option>
                    <option value="weekly">This Week</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>

            <!-- Start Date -->
            <div class="col-md-3 custom-date-field" style="display:none;">
                <label class="form-label">Start Date</label>
                <input type="date" id="startDate" class="form-control">
            </div>

            <!-- End Date -->
            <div class="col-md-3 custom-date-field" style="display:none;">
                <label class="form-label">End Date</label>
                <input type="date" id="endDate" class="form-control">
            </div>

            <!-- Item Filter -->
            <div class="col-md-3">
                <label class="form-label">Item Filter</label>
                <select id="itemFilter" class="form-select">
                    <option value="all">All Items</option>
                    {% for item in items %}
                    <option value="{{ item[0] }}">{{ item[1] }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>

        <button class="btn btn-primary mt-3" onclick="loadReport()">
            Generate Report
        </button>
    </div>

    <!-- SUMMARY CARDS -->
    <div class="row mb-4" id="summaryCards" style="display:none;">

        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <h6 class="text-muted">Total Orders</h6>
                <h3 id="sumOrders" class="fw-bold">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <h6 class="text-muted">Total Revenue</h6>
                <h3 id="sumRevenue" class="fw-bold text-success">â‚¹0.00</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <h6 class="text-muted">Avg Bill Value</h6>
                <h3 id="sumAvg" class="fw-bold">â‚¹0.00</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <h6 class="text-muted">Items Sold</h6>
                <h3 id="sumItems" class="fw-bold">0</h3>
            </div>
        </div>

    </div>

    <!-- REPORT TABLE -->
    <div class="card shadow-sm p-3">
        <h5>Report Results</h5>

        <div style="max-height: 450px; overflow-y: auto;">
            <table class="table table-bordered table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>Order ID</th>
                        <th>Table</th>
                        <th>Date-Time</th>
                        <th>Items</th>
                        <th class="text-end">Amount (â‚¹)</th>
						<div class="d-flex justify-content-end gap-2 mb-2">
							<button class="btn btn-success" onclick="downloadCSV()">Download CSV</button>
						</div>

                    </tr>
                </thead>
                <tbody id="reportTable">
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">
                            No data found. Apply filters above.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- JAVASCRIPT FOR FILTER BEHAVIOR ONLY (no backend yet) -->
<script>
document.getElementById("quickFilter").addEventListener("change", function () {
    let val = this.value;
    let customFields = document.querySelectorAll(".custom-date-field");

    if (val === "custom") {
        customFields.forEach(f => f.style.display = "block");
    } else {
        customFields.forEach(f => f.style.display = "none");
        setAutoDates(val);
    }
});


function setAutoDates(filter) {
    let today = new Date();
    let start = new Date();
    let end = new Date();

    if (filter === "daily") {
        // Today only
        start = today;
        end = today;
    }
    else if (filter === "weekly") {
        // Monday to Sunday
        let day = today.getDay();
        let diff = today.getDate() - day + (day === 0 ? -6 : 1);
        start = new Date(today.setDate(diff));
        end = new Date();
    }

    document.getElementById("startDate").value = start.toISOString().slice(0, 10);
    document.getElementById("endDate").value = end.toISOString().slice(0, 10);
}

async function loadReport() {
    let filter = document.getElementById("quickFilter").value;
    let start = document.getElementById("startDate").value;
    let end = document.getElementById("endDate").value;
    let item = document.getElementById("itemFilter").value;

    if (filter !== "custom") {
        setAutoDates(filter);
        start = document.getElementById("startDate").value;
        end = document.getElementById("endDate").value;
    }

    let payload = {
        start_date: start,
        end_date: end,
        item_id: item
    };

    const res = await fetch("/api/reports", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    renderSummary(data.summary);
    renderTable(data.rows);
}


function renderSummary(sum) {
    document.getElementById("summaryCards").style.display = "flex";
    document.getElementById("sumOrders").innerText = sum.total_orders;
    document.getElementById("sumRevenue").innerText = "â‚¹" + sum.total_revenue.toFixed(2);
    document.getElementById("sumAvg").innerText = "â‚¹" + sum.avg_bill.toFixed(2);
    document.getElementById("sumItems").innerText = sum.total_items_sold;
}


function renderTable(rows) {
    const tbody = document.getElementById("reportTable");
    tbody.innerHTML = "";

    if (rows.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-3">No data found.</td>
            </tr>`;
        return;
    }

    rows.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${r.order_id}</td>
            <td>${r.table_no}</td>
            <td>${r.datetime}</td>
            <td>${r.items}</td>
            <td class="text-end">â‚¹${r.amount.toFixed(2)}</td>
        </tr>`;
    });
}

function downloadCSV() {
    const rows = document.querySelectorAll("#reportTable tr");

    if (rows.length === 0) {
        alert("No data to download!");
        return;
    }

    let csv = "Order ID,Table,Date-Time,Items,Amount (â‚¹)\n";

    rows.forEach(row => {
        const cols = row.querySelectorAll("td");

        if (cols.length > 0) {
            let rowData = [
                cols[0].innerText.trim(),
                cols[1].innerText.trim(),
                cols[2].innerText.trim(),
                '"' + cols[3].innerText.trim().replace(/"/g, '""') + '"', // Handle commas + quotes
                cols[4].innerText.replace("â‚¹", "").trim()
            ];

            csv += rowData.join(",") + "\n";
        }
    });

    // Create Blob for download
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    // Create file download link
    const link = document.createElement("a");
    link.href = url;

    let today = new Date().toISOString().slice(0, 10);
    link.download = `report_${today}.csv`;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


</script>

{% endblock %}
