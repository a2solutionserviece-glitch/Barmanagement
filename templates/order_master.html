{% extends "base.html" %}
{% block title %}Order Master{% endblock %}
{% block content %}

<style>
:root{
  --glass-bg: rgba(255,255,255,0.75);
  --glass-border: rgba(255,255,255,0.6);
  --accent: #2563eb;
  --success: #16a34a;
  --muted: #6b7280;
}

body { background: linear-gradient(180deg,#f7fbff 0%, #f3f6ff 100%); }

/* TABLE CARDS */
.table-card {
    border-radius: 16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
    backdrop-filter: blur(6px) saturate(120%);
    padding: 18px;
    box-shadow: 0 8px 24px rgba(16,24,40,0.08);
    cursor: pointer;
    transition: transform .22s, box-shadow .22s;
    border: 1px solid rgba(255,255,255,0.6);
}
.table-card:hover { transform: translateY(-4px); box-shadow: 0 14px 30px rgba(16,24,40,0.12); }
.table-card h4{ margin:0; font-weight:600; }
.table-meta { margin-top:8px; color:var(--muted); font-size:0.7rem; }
.status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }

/* ORDER PANEL */
.order-panel {
    position: fixed;
    right: -860px;
    top: 0;
    width: 860px;
    height: 100vh;
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.82));
    backdrop-filter: blur(8px) saturate(120%);
    transition: right .32s cubic-bezier(.2,.9,.2,1);
    overflow: hidden;
    border-left: 1px solid rgba(13,42,148,0.06);
    z-index: 9999;
}
.order-panel.open { right: 0; }
.order-inner { display:flex; height:100%; }
.order-side { width:50%; padding:20px; box-sizing:border-box; overflow-y:auto; }
.order-side.left{ border-right:1px solid rgba(16,24,40,0.03); }
.order-header{ display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; }
.small-muted{ color:var(--muted); font-size:0.9rem; }

   /* Make cart scrollable */
    #cartContainer {
        max-height: calc(100vh - 220px); /* adjust height */
        overflow-y: auto;
        padding-right: 8px;
    }

    #cartContainer::-webkit-scrollbar {
        width: 6px;
    }

    #cartContainer::-webkit-scrollbar-thumb {
        background: #c4c4c4;
        border-radius: 10px;
    }


/* CART */
.cart-list{ max-height: calc(100vh - 230px); overflow-y:auto; background: #9CB1B5; }
.cart-item{ display:flex; justify-content:space-between; gap:10px; align-items:center; padding:12px; border-radius:30px; background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75)); border:1px solid rgba(16,24,40,0.03); margin-bottom:5px; box-shadow:0 6px 16px rgba(0,0,0,0.03); }
.qty-controls button{ background:transparent; border:1px solid rgba(16,24,40,0.06); border-radius:3px; padding:6px 8px; }
.qty-controls .qty{ padding:0 10px; }

/* FOOTER */
.panel-footer{ position:absolute; right:0; bottom:0; width:410px; box-shadow:0 -8px 30px rgba(16,24,40,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); padding:16px; box-sizing:border-box; }
.panel-footer .btn{ border-radius:4px; padding:2px 10px; }
.btn-primary{ background:linear-gradient(90deg,var(--accent), #3b82f6); color:white; border:none; box-shadow:0 8px 20px rgba(59,130,246,0.12); }
.btn-success{ background:linear-gradient(90deg,var(--success), #10b981); color:white; border:none; }
.btn-outline-secondary{ border:1px solid rgba(16,24,40,0.06); background:transparent; }

/* Responsive */
@media (max-width:1000px){ .order-panel{ width:100vw; right:-100vw; } .panel-footer{ width:50vw; } }
</style>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:12000;">
  <div class="toast align-items-center text-white bg-success border-0" id="orderSavedToast" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Saved</div>
      <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button"></button>
    </div>
  </div>
</div>

<h2 class="mb-4">Order Master / ऑर्डर मास्टर</h2>

<div class="row g-4">
  {% for t in tables %}
  <div class="col-md-3">
    <div class="card table-card text-center p-3" onclick="openOrderPanel({{ t[0] }}, {{ t[1] }}, '{{ t[3] }}')">
      <h4>{{ t[2] }}</h4>
      <div class="table-meta">
        {% if t[3] == 'AVAILABLE' %}
          <span class="status-dot" style="background:#16a34a;"></span><span class="small-muted">Available</span>
        {% elif t[3] == 'RUNNING' %}
          <span class="status-dot" style="background:#f59e0b;"></span><span class="small-muted">Running</span>
        {% elif t[3] == 'BILLED' %}
          <span class="status-dot" style="background:#ef4444;"></span><span class="small-muted">Billed</span>
        {% else %}
          <span class="status-dot" style="background:#9ca3af;"></span><span class="small-muted">Unknown</span>
        {% endif %}
      </div>
	  <h6> Current Order No:{{ t[4] }}</h6>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Order Panel -->
<div aria-hidden="true" class="order-panel shadow-lg" id="orderPanel">
  <div class="order-inner">
    <div class="order-side left">
      <div class="order-header">
        <div>
          <h4 id="orderTableTitle">Table</h4>
          <div class="small-muted">Table ID: <span id="orderTableId">-</span></div>
        </div>
        <div>
          <button class="btn btn-outline-secondary btn-sm" onclick="closeOrderPanel()">Close</button>
        </div>
      </div>

    <div class="mt-3">
    <input class="form-control mb-3" id="orderSearch" placeholder="Search item..." />

    <div class="item-list">
        <div id="itemListContainer"></div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    loadItems();

    // SEARCH FILTER
    document.getElementById("orderSearch").addEventListener("keyup", function () {
        let searchText = this.value.toLowerCase();
        let items = document.querySelectorAll(".item-card");

        items.forEach(item => {
            let name = item.getAttribute("data-name").toLowerCase();

            if (name.includes(searchText)) {
                item.style.display = "block";
            } else {
                item.style.display = "none";
            }
        });
    });
});

// LOAD ITEMS FROM API
function loadItems() {
    fetch("/api/items")
        .then(res => res.json())
        .then(data => renderItems(data))
        .catch(err => console.error("Error loading items:", err));
}

// RENDER ITEMS
function renderItems(items) {
    const container = document.getElementById("itemListContainer");
    container.innerHTML = "";

    items.forEach(it => {
    const row = document.createElement("div");
    row.className = "item-card";
    row.setAttribute("data-name", it.item_name.toLowerCase());

    row.innerHTML = `
        <div class="item-info">
            <strong>${it.item_name}</strong><br/>
			<medium>Stock: ${Number(it.quantity).toFixed(0)}</medium>
            <small>Price: ₹${Number(it.selling_price).toFixed(2)}</small>
        </div>
        <button class="btn-add">Add</button>
    `;

    // Add button
    row.querySelector(".btn-add").addEventListener("click", (e) => {
        e.stopPropagation();
        addToCart(it);
    });

    // Entire row clickable
    row.addEventListener("click", () => addToCart(it));

    container.appendChild(row);
});

}
</script>

<style>
    /* Item List Container */
    #itemListContainer {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        padding-right: 8px;
    }

    /* Smooth scrollbar */
    #itemListContainer::-webkit-scrollbar {
        width: 6px;
    }
    #itemListContainer::-webkit-scrollbar-thumb {
        background: #c4c4c4;
        border-radius: 10px;
    }

    /* Modern Item Card */
    .item-card {
        background: #eef2ff;
        border-radius: 12px;
        padding: 14px 18px;
        margin-bottom: 10px;
        border: 1px solid #e5e5e5;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Hover effect */
    .item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 14px rgba(0,0,0,0.08);
        border-color: #dcdcdc;
    }

    /* Item Text */
    .item-info strong {
        font-size: 16px;
        color: #333;
    }

    .item-info small {
        color: #888;
        font-size: 12px;
    }

    /* Add Button Modern */
    .btn-add {
        background: #0066ff;
        color: #fff;
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 8px;
        border: none;
        transition: 0.2s;
    }

    .btn-add:hover {
        background: #004ecc;
    }
</style>


    </div>

    <div class="order-side right">
      <div class="order-header">
        <div>
          <h4>Cart</h4>
          <div class="small-muted">Selected items for current order</div>
        </div>
        <div>
          <button class="btn btn-outline-secondary btn-sm" onclick="clearCart()">Clear</button>
        </div>
      </div>

      <div class="p-2">
        <div class="cart-list" id="cartContainer"></div>
        <div class="text-muted mt-2" id="emptyCartNotice">Cart is empty. Add items from the left.</div>

      </div>
    </div>
  </div>

  <div class="panel-footer d-none d-md-flex flex-column" style="right:0; width:430px;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="small-muted">Table: <strong id="footerTableNo">-</strong></div>
      <div class="small-muted">Items: <strong id="footerItemCount">0</strong></div>
    </div>
    <div class="total-row">
      <div><strong>Total</strong></div>
      <div><strong id="cartTotal">₹0.00</strong></div>
    </div>
    <div class="d-flex gap-2 mt-2">
      
      <button class="btn btn-primary w-33" id="saveOrderBtn">Save Order</button>
      <button class="btn btn-success w-33" id="printBillBtn">Print Bill</button>
    </div>
  </div>
</div>

<!-- SCRIPT: cleaned and optimized (Option A: instant filter) -->
<script>
/* Global state */
let CURRENT_TABLE_ID = null;
let CURRENT_TABLE_NO = null;
let CART = [];            // {id, name, unit, price, qty}
let RUNNING_ORDER_ID = null;
let searchTimer = null;

/* Helper: show toast */
function showToast(message) {
    const toastEl = document.getElementById('orderSavedToast');
    if (toastEl && typeof bootstrap !== 'undefined') {
        document.getElementById('toastMessage').innerText = message;
        const t = new bootstrap.Toast(toastEl);
        t.show();
        return;
    }
    alert(message);
}


/* Open / close panel */
function openOrderPanel(tableId, tableNo, status){
  CURRENT_TABLE_ID = tableId;
  CURRENT_TABLE_NO = tableNo;
  document.getElementById('orderTableTitle').innerText = 'Table ' + tableNo;
  document.getElementById('orderTableId').innerText = tableId;
  document.getElementById('footerTableNo').innerText = tableNo;
  document.getElementById('orderPanel').classList.add('open');

  loadItems();
  if (status === 'RUNNING') loadRunningOrder(tableId);
  else { RUNNING_ORDER_ID = null; CART = []; renderCart(); }
}
function closeOrderPanel(){ document.getElementById('orderPanel').classList.remove('open'); }

/* Load running order for a table */
async function loadRunningOrder(tableId){
  try {
    const res = await fetch(`/api/get_running_order/${tableId}`);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (!data.ok || !data.order_id) {
      RUNNING_ORDER_ID = null;
      CART = [];
      renderCart();
      return;
    }
    RUNNING_ORDER_ID = data.order_id;
    CART = data.items.map(it => ({ id: it.item_id, name: it.item_name, unit: it.unit, price: it.price, qty: it.qty }));
    renderCart();
  } catch (e) {
    console.error('loadRunningOrder error', e);
    RUNNING_ORDER_ID = null;
    CART = [];
    renderCart();
  }
}

/* Filter items (instant clientside) */
function filterItems() {
    const input = document.getElementById('orderSearch');
    const search = input ? input.value.trim().toLowerCase() : '';
    const rows = document.querySelectorAll('#itemListContainer .item-card');

    rows.forEach(r => {
        const text = r.textContent.toLowerCase();
        r.style.display = text.includes(search) ? 'flex' : 'none';
    });
}

/* Cart operations */
function addToCart(item){
  const existing = CART.find(c => c.id === item.id);
  if (existing) existing.qty += 1;
  else CART.push({ id: item.id, name: item.item_name, unit: item.unit, price: Number(item.selling_price), qty: 1 });
  renderCart();
}

function updateQty(itemId, delta){
  const idx = CART.findIndex(c => c.id === itemId);
  if (idx === -1) return;
  CART[idx].qty += delta;
  if (CART[idx].qty <= 0) {
    if (RUNNING_ORDER_ID) deleteOrderItem(RUNNING_ORDER_ID, itemId);
    CART.splice(idx, 1);
  }
  renderCart();
}

function removeItem(itemId, fromUI=false){
  CART = CART.filter(c => c.id !== itemId);
  renderCart();
  if (fromUI && RUNNING_ORDER_ID) deleteOrderItem(RUNNING_ORDER_ID, itemId);
}

/* Backend delete helper */
async function deleteOrderItem(orderId, itemId){
  try {
    const res = await fetch('/api/delete_order_item', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ order_id: orderId, item_id: itemId })
    });
    const out = await res.json();
    if (!out.ok) console.error('deleteOrderItem failed', out.error);
    if (RUNNING_ORDER_ID) loadRunningOrder(CURRENT_TABLE_ID);
  } catch (e) {
    console.error('deleteOrderItem error', e);
  }
}

/* Clear cart */
function clearCart(){
  if (!confirm('Clear the cart?')) return;
  if (RUNNING_ORDER_ID) {
    fetch('/api/clear_order_items', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ order_id: RUNNING_ORDER_ID })
    }).then(r => r.json())
      .then(o => { if (!o.ok) console.error(o.error); loadRunningOrder(CURRENT_TABLE_ID); });
    return;
  }
  CART = [];
  renderCart();
}

/* Render cart UI */
function renderCart(){
  const container = document.getElementById('cartContainer');
  const emptyNotice = document.getElementById('emptyCartNotice');
  const totalEl = document.getElementById('cartTotal');
  const totalMobile = document.getElementById('cartTotalMobile');
  const footerCount = document.getElementById('footerItemCount');

  const cartTotal = CART.reduce((s, it) => s + (it.price * it.qty), 0);
  container.innerHTML = '';

  if (CART.length === 0) {
    emptyNotice.style.display = 'block';
  } else {
    emptyNotice.style.display = 'none';
    CART.forEach(it => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <div style="flex:1;">
          <div><strong>${it.name}</strong></div>
          <div class="small-muted">${it.unit}</div>
        </div>
        <div style="width:140px; text-align:right;">
          <div style="font-weight:600">₹${(it.price * it.qty).toFixed(2)}</div>
          <div class="qty-controls mt-1 d-flex justify-content-end">
            <button class="btn btn-sm btn-light" onclick="updateQty(${it.id}, -1)">-</button>
            <div class="qty">${it.qty}</div>
            <button class="btn btn-sm btn-light" onclick="updateQty(${it.id}, 1)">+</button>
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeItem(${it.id}, true)">Remove</button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  if (totalEl) totalEl.innerText = `₹${cartTotal.toFixed(2)}`;
  if (totalMobile) totalMobile.innerText = `₹${cartTotal.toFixed(2)}`;
  if (footerCount) footerCount.innerText = CART.reduce((s,it) => s + it.qty, 0);
}

/* Save order */
async function saveOrder(){
  if (!CURRENT_TABLE_ID) return showToast('No table selected!');
  if (CART.length === 0) return showToast('Cart is empty!');

  const payload = {
    table_id: CURRENT_TABLE_ID,
    table_no: CURRENT_TABLE_NO,
    items: CART.map(c => ({ item_id: c.id, qty: c.qty, price: c.price }))
  };

  try {
    const res = await fetch('/save_order', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const out = await res.json();
    if (out.ok) {
      showToast('Order Saved! Order ID: ' + out.order_id);
      RUNNING_ORDER_ID = out.order_id;
      await loadRunningOrder(CURRENT_TABLE_ID);
      closeOrderPanel();
      window.location.reload();
    } else {
      showToast('Error saving order: ' + (out.error || 'Unknown'));
    }
  } catch (e) {
    console.error('saveOrder error', e);
    showToast('Failed to save order. Check console.');
  }
}

/* Print bill */
async function printBill(){
  if (!RUNNING_ORDER_ID) {
    if (CART.length === 0) return showToast('Cart is empty. Add items first.');
    // Auto-save
    const payload = {
      table_id: CURRENT_TABLE_ID,
      table_no: CURRENT_TABLE_NO,
      items: CART.map(c => ({ item_id: c.id, qty: c.qty, price: c.price }))
    };
    const res = await fetch('/save_order', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const out = await res.json();
    if (!out.ok) return showToast('Error saving before print: ' + out.error);
    RUNNING_ORDER_ID = out.order_id;
  }

  const orderId = RUNNING_ORDER_ID;
  const w = window.open(`/invoice/${orderId}?print=1`, '_blank');
  if (!w) return showToast('Please allow popups for invoice printing.');

  // After print, close order & free table
  setTimeout(() => {
    fetch(`/close_order/${orderId}`, { method: 'POST' })
      .then(r => r.json())
      .then(o => {
        if (o.ok) {
          showToast('Order billed & table freed.');
          window.location.reload();
        } else {
          console.error('close_order failed', o);
        }
      }).catch(e => console.error(e));
  }, 2000);
}

/* DOM ready: attach listeners */
document.addEventListener('DOMContentLoaded', () => {
  const saveBtn = document.getElementById('saveOrderBtn');
  const saveBtnMobile = document.getElementById('saveOrderBtnMobile');
  const clearBtn = document.getElementById('clearCartBtn');
  const printBtn = document.getElementById('printBillBtn');
  const searchInput = document.getElementById('orderSearch');

  if (saveBtn) saveBtn.addEventListener('click', saveOrder);
  if (saveBtnMobile) saveBtnMobile.addEventListener('click', saveOrder);
  if (clearBtn) clearBtn.addEventListener('click', () => { if (confirm('Clear cart?')) { CART = []; renderCart(); } });
  if (printBtn) printBtn.addEventListener('click', printBill);

  // Debounced client-side search (instant filter)
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(filterItems, 120);
    });
  }
});
</script>

{% endblock %}
