{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<!-- CUSTOM PREVIEW MODAL -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="previewModalTitle">Print Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="previewModalBody">
        <!-- Content loads here -->
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>



<div class="container">
  <div class="py-4">
    <h1 class="h3">Hotel Settings</h1>
    <p class="text-muted">Identity, tax details, print layout and low-stock alert configuration.</p>
  </div>

  <div class="row">
    <div class="col-md-8">
      <!-- Hotel details -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Hotel details</h5>

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Hotel name</label>
              <input id="hotelName" class="form-control" placeholder="My Hotel" />
            </div>

            <div class="col-md-6">
              <label class="form-label">Short name</label>
              <input id="shortName" class="form-control" placeholder="HotelShort" />
            </div>

            <div class="col-12">
              <label class="form-label">Address line 1</label>
              <input id="addressLine1" class="form-control" />
            </div>

            <div class="col-12">
              <label class="form-label">Address line 2</label>
              <input id="addressLine2" class="form-control" />
            </div>

            <div class="col-md-4">
              <label class="form-label">City</label>
              <input id="city" class="form-control" />
            </div>

            <div class="col-md-4">
              <label class="form-label">State</label>
              <input id="state" class="form-control" />
            </div>

            <div class="col-md-4">
              <label class="form-label">Pincode</label>
              <input id="pincode" class="form-control" />
            </div>

            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input id="phone" class="form-control" />
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input id="email" type="email" class="form-control" />
            </div>
          </div>
        </div>
      </div>

      <!-- Tax & IDs -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Tax & official IDs</h5>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">GST number</label>
              <input id="gstNumber" class="form-control" placeholder="22AAAAA0000A1Z5" />
            </div>
            <div class="col-md-6">
              <label class="form-label">PAN</label>
              <input id="panNumber" class="form-control" placeholder="AAAAA0000A" />
            </div>
          </div>
        </div>
      </div>

      <!-- Print layout -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Print layout</h5>
          <p class="text-muted">These fields are used when printing bills/receipts.</p>

          <div class="mb-2">
            <label class="form-label">Print header (visible at top of receipt)</label>
            <textarea id="printHeader" class="form-control" rows="3"></textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Print footer (terms / GST summary)</label>
            <textarea id="printFooter" class="form-control" rows="3"></textarea>
          </div>

          <div>
            <button id="previewBtn" class="btn btn-outline-secondary btn-sm">Preview print header/footer</button>
          </div>
        </div>
      </div>

      <!-- Low-stock -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Low-stock alerts</h5>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="enableLowStockAlert" />
            <label class="form-check-label" for="enableLowStockAlert">Enable low-stock alerts</label>
          </div>

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Default low-stock threshold (units)</label>
              <input id="lowStockThreshold" type="number" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Stock check interval (days)</label>
              <input id="stockCheckIntervalDays" type="number" class="form-control" />
            </div>
          </div>

          <p class="text-muted mt-2">The system will mark items with current_qty &lt;= threshold as low. You will need a backend job/cron to evaluate thresholds.</p>
        </div>
      </div>
    </div>

    <!-- Actions column -->
    <div class="col-md-4">
      <div class="card mb-3 sticky-top" style="top:20px;">
        <div class="card-body">
          <h6>Actions</h6>
          <p class="text-muted small">Save or reset hotel settings.</p>

          <div class="d-grid gap-2">
            <button id="saveBtn" class="btn btn-primary">Save settings</button>
            <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
            <div id="savedMsg" class="text-success mt-2" style="display:none;">Saved successfully ✓</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h6>Notes</h6>
          <ul class="small mb-0">
            <li>GST/PAN fields are printed on receipts and stored for compliance.</li>
            <li>Low-stock alerts require `items.current_qty` in your items table and a scheduled job to evaluate thresholds.</li>
            <li>API endpoints used: <code>/api/hotel-settings</code> (GET/POST).</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // DOM helpers
  const $ = id => document.getElementById(id);

  async function loadSettings() {
    try {
      const res = await fetch('/api/hotel-settings');
      if (!res.ok) throw new Error('Load failed: ' + res.status);
      const data = await res.json();

      // populate fields safely
      $('hotelName').value = data.hotelName || '';
      $('shortName').value = data.shortName || '';
      $('addressLine1').value = data.addressLine1 || '';
      $('addressLine2').value = data.addressLine2 || '';
      $('city').value = data.city || '';
      $('state').value = data.state || '';
      $('pincode').value = data.pincode || '';
      $('phone').value = data.phone || '';
      $('email').value = data.email || '';
      $('gstNumber').value = data.gstNumber || '';
      $('panNumber').value = data.panNumber || '';
      $('printHeader').value = data.printHeader || '';
      $('printFooter').value = data.printFooter || '';
      $('enableLowStockAlert').checked = !!data.enableLowStockAlert;
      $('lowStockThreshold').value = data.lowStockThreshold ?? 5;
      $('stockCheckIntervalDays').value = data.stockCheckIntervalDays ?? 1;

    } catch (err) {
      console.error(err);
      alert('Error loading settings: ' + err.message);
    }
  }

  async function saveSettings() {
    const payload = {
      hotelName: $('hotelName').value,
      shortName: $('shortName').value,
      addressLine1: $('addressLine1').value,
      addressLine2: $('addressLine2').value,
      city: $('city').value,
      state: $('state').value,
      pincode: $('pincode').value,
      phone: $('phone').value,
      email: $('email').value,
      gstNumber: $('gstNumber').value,
      panNumber: $('panNumber').value,
      printHeader: $('printHeader').value,
      printFooter: $('printFooter').value,
      enableLowStockAlert: $('enableLowStockAlert').checked,
      lowStockThreshold: Number($('lowStockThreshold').value || 0),
      stockCheckIntervalDays: Number($('stockCheckIntervalDays').value || 1)
    };

    try {
      const res = await fetch('/api/hotel-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error('Save failed: ' + res.status);
      $('savedMsg').style.display = 'block';
      setTimeout(() => { $('savedMsg').style.display = 'none'; }, 2500);
    } catch (err) {
      console.error(err);
      alert('Error saving settings: ' + err.message);
    }
  }

  function resetForm() {
    if (!confirm('Reset settings to defaults?')) return;
    $('hotelName').value = '';
    $('shortName').value = '';
    $('addressLine1').value = '';
    $('addressLine2').value = '';
    $('city').value = '';
    $('state').value = '';
    $('pincode').value = '';
    $('phone').value = '';
    $('email').value = '';
    $('gstNumber').value = '';
    $('panNumber').value = '';
    $('printHeader').value = '';
    $('printFooter').value = '';
    $('enableLowStockAlert').checked = true;
    $('lowStockThreshold').value = 5;
    $('stockCheckIntervalDays').value = 1;
  }

  function previewPrint() {
    const header = $('printHeader').value || "<no header>";
    const footer = $('printFooter').value || "<no footer>";

    // Replace \n with <br> for HTML display
    const html = `
        <strong>Header:</strong><br>
        ${header.replace(/\n/g, "<br>")}
        <hr>
        <strong>Footer:</strong><br>
        ${footer.replace(/\n/g, "<br>")}
    `;

    // Set modal title (custom name instead of URL)
    document.getElementById("previewModalTitle").innerText = "Print Preview – Hotel Yarmala";

    // Set modal content
    document.getElementById("previewModalBody").innerHTML = html;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById("previewModal"));
    modal.show();
}


  document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    $('saveBtn').addEventListener('click', saveSettings);
    $('resetBtn').addEventListener('click', resetForm);
    $('previewBtn').addEventListener('click', previewPrint);
  });
</script>
{% endblock %}
