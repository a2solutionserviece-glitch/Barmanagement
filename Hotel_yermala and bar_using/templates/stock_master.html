{% extends "base.html" %}
{% block title %}Stock Master{% endblock %}
{% block content %}

<div class="container-box">
    <h2 class="mb-4"> Daily Stock Master</h2>

    <!-- ACTION BUTTONS -->
    <div class="mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#stockInModal">
            + Stock In
        </button>
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#stockOutModal">
            - Stock Out
        </button>
    </div>

    <!-- SEARCH BAR -->
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" id="searchStock" class="form-control" placeholder="Search item...">
        </div>
    </div>

    <!-- STOCK TABLE -->
    <div class="card card-box p-4">
        <div class="card-header bg-dark text-white rounded mb-3">
            <h4 class="m-0">Current Stock</h4>
        </div>

        <div style="max-height: 450px; overflow-y: auto; border-radius: 8px;">
            <table class="table table-hover table-bordered align-middle mt-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Item</th>
                        <th>Available Stock</th>
                        <th>Unit</th>
                        <th>Last Movement</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody id="stockTable">
                    {% for s in stocks %}
                    <tr>
                        <td>{{ s.id }}</td>
                        <td>{{ s.item_name }}</td>
                        <td>{{ s.current_stock }}</td>
                        <td>{{ s.unit }}</td>
                        <td>{{ s.updated_at }}</td>
                        <td>
                            <button class="btn btn-sm btn-info"
                                onclick="openHistory({{ s.id }})">History</button>

                            <button class="btn btn-sm btn-warning"
										onclick='openUpdateModal({{ s | tojson | safe }})'>
									Update
								</button>

                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</div>

<!-- MODAL — STOCK IN -->
<div class="modal fade" id="stockInModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Stock In (Add)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form action="/add_stock" method="POST">

                    <div class="mb-3">
                        <label>Select Item</label>
                        <select class="form-select" name="item_id" required>
                            <option value="">Select</option>
                            {% for item in items %}
                            <option value="{{ item[0] }}">{{ item[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>Quantity</label>
                        <input type="number" step="0.01" name="quantity" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label>Notes</label>
                        <textarea class="form-control" name="notes"></textarea>
                    </div>

                    <button class="btn btn-success w-100">Add Stock</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- MODAL — STOCK OUT -->
<div class="modal fade" id="stockOutModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">

            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Stock Out (Reduce)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form action="/reduce_stock" method="POST">

                    <div class="mb-3">
                        <label>Select Item</label>
                        <select class="form-select" name="item_id" required>
                            <option value="">Select</option>
                            {% for item in items %}
                            <option value="{{ item[0] }}">{{ item[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>Quantity</label>
                        <input type="number" step="0.01" name="quantity" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label>Notes</label>
                        <textarea class="form-control" name="notes"></textarea>
                    </div>

                    <button class="btn btn-danger w-100">Reduce Stock</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- MODAL — UPDATE STOCK TRANSACTION -->
<div class="modal fade" id="updateStockModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">

            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Update Stock Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form action="/update_stock" method="POST">

                    <input type="hidden" id="update_trans_id" name="trans_id">

                    <div class="mb-3">
                        <label>Quantity</label>
                        <input type="number" id="update_quantity" step="0.01"
                               class="form-control" name="quantity" required>
                    </div>

                    <div class="mb-3">
                        <label>Notes</label>
                        <textarea class="form-control" id="update_notes" name="notes"></textarea>
                    </div>

                    <button class="btn btn-warning w-100">Update</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- MODAL — STOCK HISTORY -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Stock Movement History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="historyBody">
                <!-- History will load here -->
            </div>

        </div>
    </div>
</div>


<!-- JS FUNCTIONS -->
<script>

// LIVE SEARCH
document.getElementById("searchStock").addEventListener("keyup", function () {
    let input = this.value.toLowerCase();
    let rows = document.querySelectorAll("#stockTable tr");

    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
    });
});

// UPDATE STOCK POPUP LOADER
function openUpdateModal(stock) {
    document.getElementById("update_trans_id").value = stock.id;
    document.getElementById("update_quantity").value = stock.current_stock;
    document.getElementById("update_notes").value = "";

    new bootstrap.Modal(document.getElementById("updateStockModal")).show();
}



// LOAD HISTORY WITH AJAX
function openHistory(item_id) {
    fetch(`/stock_history/${item_id}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById("historyBody").innerHTML = html;
            new bootstrap.Modal(document.getElementById("historyModal")).show();
        });
}

// ---- Low stock checked

let lowStockThreshold = 0;

// Load low-stock threshold from settings API
async function loadSettingsThreshold() {
    try {
        const res = await fetch('/api/hotel-settings');
        const data = await res.json();
        lowStockThreshold = data.lowStockThreshold ?? 0;
        highlightLowStockRows();
    } catch (err) {
        console.error("Failed to load settings", err);
    }
}

function highlightLowStockRows() {
    const rows = document.querySelectorAll("#stockTable tr");

    rows.forEach(row => {
        let stockValue = parseFloat(row.children[2].innerText);

        if (!isNaN(stockValue) && stockValue <= lowStockThreshold) {
            row.classList.add("table-danger");   // RED ROW
        } else {
            row.classList.remove("table-danger");
        }
    });
}

document.addEventListener("DOMContentLoaded", () => {
    loadSettingsThreshold();
});



</script>

{% endblock %}
